# Nginx configuration generated by Ansible

load_module '/usr/lib64/nginx/modules/ngx_stream_module.so';
worker_processes 4;
worker_rlimit_nofile 40000;

events {
    worker_connections 8192;
}

stream {
   {% for upstream in nginx_config.upstreams %}
    upstream {{ upstream.name }} {
        least_conn;
        {% for server in upstream.servers %}
        server {{ server.ip }}:{{ server.port }} max_fails={{ server.max_fails }} fail_timeout={{ server.fail_timeout }};
        {% endfor %}
    }
  {% endfor %}

    
    {% for lb in nginx_config.load_balancers %}
    server {
        listen {{ lb.listen_port }};
        proxy_pass {{ lb.upstream }};
    }
    {% endfor %}
    
}
